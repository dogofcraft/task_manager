## 1 背景与现状

目前前端通过**模拟进度条**向用户展示文件处理状态。后端仅在全部处理完成后一次性返回文件，导致：

1. 前端实现复杂，难以维护和复用；
2. 真正的处理耗时、阶段无法感知，用户体验欠佳；
3. 一旦前端与后端状态机不一致，进度展示会出错。

为降低前端复杂度并提升稳定性，需要在后端推出**统一进度服务（Unified Progress Service, UPS）**，负责处理任务全生命周期的状态管理与对外推送。

## 2 目标

- **G 1 可观测性**：后端准确记录任务在各处理阶段的进度百分比、耗时、异常信息。
- **G2 前端无感知细节**：前端仅订阅简单、统一的进度接口；无需了解各子模块实现。
- **G3 易集成**：未来新增处理模块（OCR、格式转换、QA 检测等）时，可零改动接入 UPS。
- **G4 高可用**：服务可水平扩展；单点失败不影响整体任务运行。

## 3 范围

### 3.1 功能范围（In‑Scope）

1. 任务注册（单文件或批量）及唯一 Task ID 生成。
2. 多阶段进度追踪（上传→脱敏→翻译→术语校对→导出）。
3. 进度查询 REST API & WebSocket 实时推送。
4. 任务取消 / 重试 / 批量下载。
5. 权限校验（JWT / SSO 透传）。
6. 日志、监控指标（Prometheus）, 告警（Grafana Alert）。

### 3.2 非功能范围（Out‑of‑Scope）

- 具体 NLP / LLM 算法实现；
- 前端 UI 细节；
- 计费与配额策略（由计费微服务处理）。

## 4 用户画像 & 使用场景

|                  |                                 |                                   |
| ---------------- | ------------------------------- | --------------------------------- |
| Persona          | 角色痛点                        | 使用 UPS 的价值                   |
| **律师团队成员** | 需要实时了解 50+ 份文件处理进度 | 一键查看进度，及时安排后续审校    |
| **前端开发**     | 维护多套进度计算逻辑            | 只需订阅 /progress 端点，减少维护 |
| **运维**         | 定位后端瓶颈 & 异常             | 统一指标、日志方便排障            |

## 5 功能需求

### 5.1 任务注册

- **R‑1**：支持 `multipart/form-data` 上传单文件或压缩包；
- **R‑2**：返回 `task_id`、预计队列等待时长【TBD】。

### 5.2 状态机定义

```
stateDiagram-v2
    %% ===== 统一进度状态机（翻译 QA 可开关） =====
    [*] --> Uploaded            : 文档上传
    Uploaded --> Queued         : 待处理（排队）
    Queued --> Parsing          : 文档解析（格式解码 / 文本抽取）

    %% --- OCR 可选 ---
    Parsing --> OCR             : OCR 识别（扫描件可选）
    OCR --> EntityExtraction    : 实体抽取（开启校对）
    OCR --> Processing          : 跳过校对 → 直接处理（关闭校对）

    %% --- 无 OCR ---
    Parsing --> EntityExtraction: 实体抽取（开启校对）
    Parsing --> Processing      : 跳过校对 → 直接处理（关闭校对）

    %% --- 校对流程 ---
    EntityExtraction --> EntityReview   : 抽取完成 → 用户校对
    EntityReview --> Processing         : 任务执行（脱敏 / 翻译 / 混合）

    %% --- 翻译 QA（仅翻译功能 & 开关开启时执行） ---
    Processing --> QA           : 翻译质检（开启 QA）
    Processing --> Assembling   : 跳过 QA（未翻译或关闭 QA）
    QA --> Assembling           : QA 完成 → 组装

    Assembling --> Packaging    : 打包输出
    Packaging --> Completed     : 完成

    %% ===== 失败分支 =====
    Uploaded --> Failed
    Queued --> Failed
    Parsing --> Failed
    OCR --> Failed
    EntityExtraction --> Failed
    EntityReview --> Failed
    Processing --> Failed
    QA --> Failed
    Assembling --> Failed
    Packaging --> Failed
```

> *占位：如需添加 OCR、格式转换等阶段，可在此拓展。*

### 5.3 进度查询 API

|         |                                        |                                 |
| ------- | -------------------------------------- | ------------------------------- |
| Method  | Path                                   | 描述                            |
| **GET** | `/api/v1/tasks/{task_id}`              | 返回整体进度、各阶段百分比、ETA |
| **GET** | `/api/v1/tasks?status=queued&limit=50` | 支持分页过滤                    |
| **WS**  | `/ws/progress/{task_id}`               | 服务端推送 JSON 增量更新        |

**响应示例**

```
{
  "task_id": "123e4567-e89b-12d3-a456-426614174000",
  "status": "Assembling",
  "percent": 75,
  "stages": {
    "upload": 100,
    "queued": 100,
    "parsing": 100,
    "ocr": 0,
    "entity_extract": 0,
    "entity_review": 0,
    "processing": 75,
    "qa": 0,                // 未启用翻译 QA 或仅脱敏流程
    "assembling": 0,
    "packaging": 0
  },
  "requires_user_action": false,
  "eta_seconds": 180
}
```

### 5.4 任务控制

- **Cancel**：`POST /tasks/{task_id}/cancel`，返回 HTTP 202。
- **Retry**：失败后可在 1 小时内重试一次。

### 5.5 安全 & 权限

- OAuth2 Bearer Token 或 SSO Cookie；
- Tenant / Project 隔离；
- 访问频率限流：默认 100 rps / IP。

## 6 非功能需求

|            |                                               |
| ---------- | --------------------------------------------- |
| 类别       | 指标                                          |
| **性能**   | 99th 进度查询接口 < 200 ms；WS 推送延迟 < 1 s |
| **可用性** | SLA ≥ 99.9%；支持灰度发布 & 滚动升级          |
| **扩展性** | 支持 10k 并发任务；水平扩容无感知             |
| **安全**   | 传输全程 TLS 1.2+；GDPR & 律所保密合规        |
| **监控**   | Prometheus 暴露：队列长度、阶段耗时、失败率   |

## 7 数据模型

|                     |                                                              |          |
| ------------------- | ------------------------------------------------------------ | -------- |
| 表 / 集合           | 关键字段                                                     | 说明     |
| **tasks**           | `task_id`(PK), `user_id`, `status`, `current_stage`, `percent`, `created_at`, `updated_at` | 任务主表 |
| **task_stage_logs** | `id`, `task_id`, `stage`, `percent`, `msg`, `ts`             | 进度快照 |

## 8 系统架构 & 流程

```
Frontend ←WS / REST→ UPS (FastAPI) ←gRPC→ Worker Pool → NLP pipelines
                             ↑            ↑
                Redis Stream / Queue     Postgres/ClickHouse
```

> *详细部署图见【architecture‑diagram.png】*

## 9 依赖 & 风险

|      |                                    |          |                         |
| ---- | ---------------------------------- | -------- | ----------------------- |
| 类型 | 描述                               | 风险等级 | 应对                    |
| 技术 | WebSocket 推送在部分企业网关被阻断 | 中       | 提供 SSE / 轮询降级方案 |
| 人员 | Worker 现有代码未实现阶段化回调    | 高       | 研发评审确认改造工时    |
| 时间 | 对接 SSO 需协调 IT 部门            | 中       | 提前沟通排期            |